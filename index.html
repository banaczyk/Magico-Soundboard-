<!DOCTYPE html>
<html lang="pl">
<head>
<meta charset="UTF-8">
<title>Jinglownica – v3</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<!-- Bootstrap -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

<style>
    .tile {
        width: 100%;
        padding-top: 100%;
        position: relative;
        background: #343a40;
        color: #fff;
        border-radius: 12px;
        cursor: pointer;
        user-select: none;
        text-align: center;
        font-weight: 600;
        transition: 0.2s;
        overflow: hidden;
    }
    .tile.playing {
        background: #0d6efd;
    }
    .tile-content {
        position: absolute;
        inset: 0;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 10px;
        overflow: hidden;
        word-break: break-word;
        font-size: 0.9rem;
        pointer-events: none;
    }
    .progress-container {
        position: absolute;
        left: 0;
        right: 0;
        bottom: 0;
        padding: 6px;
    }
    .reset-btn {
        position: absolute;
        top: 6px;
        right: 6px;
        background: rgba(0,0,0,0.4);
        border: none;
        color: white;
        width: 28px;
        height: 28px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        z-index: 10;
    }
    .reset-btn:hover {
        background: rgba(0,0,0,0.6);
    }
</style>
</head>

<body class="bg-light">

<div class="container py-5">
    <h1 class="mb-4">Jinglownica</h1>

    <div class="row g-4">
        <!-- Lewy panel -->
        <div class="col-md-3">
            <div class="card">
                <div class="card-header bg-dark text-white">
                    Wybierz pliki audio
                </div>
                <div class="card-body">
                    <input type="file" id="fileInput" multiple accept="audio/*" class="form-control mb-3">
                    <button id="clearBtn" class="btn btn-danger w-100">Wyczyść listę</button>
                    <p class="text-muted small mt-3 mb-0">
                        Pliki zapisywane są lokalnie w Twojej przeglądarce.<br>
                        Nic nie jest wysyłane na serwer.
                    </p>
                </div>
            </div>
        </div>

        <!-- Prawy panel: kafelki -->
        <div class="col-md-9">
            <div id="tiles" class="row g-3"></div>
        </div>
    </div>
</div>

<script>
// IndexedDB SETUP
let db;

const request = indexedDB.open("JinglownicaDB", 1);

request.onupgradeneeded = function (e) {
    db = e.target.result;
    db.createObjectStore("audioFiles", { keyPath: "id", autoIncrement: true });
};

request.onsuccess = function (e) {
    db = e.target.result;
    loadSavedFiles();
};

// DOM
const fileInput = document.getElementById('fileInput');
const tiles = document.getElementById('tiles');
const clearBtn = document.getElementById('clearBtn');

// Load saved files
function loadSavedFiles() {
    const tx = db.transaction("audioFiles", "readonly");
    const store = tx.objectStore("audioFiles");

    const requestAll = store.getAll();

    requestAll.onsuccess = function () {
        requestAll.result.forEach(data =>
            createTile(data.id, data.name, data.blob)
        );
    };
}

// Add new files
fileInput.addEventListener('change', () => {
    [...fileInput.files].forEach(file => {
        const reader = new FileReader();

        reader.onload = function (e) {
            const blob = new Blob([e.target.result], { type: file.type });

            const tx = db.transaction("audioFiles", "readwrite");
            tx.objectStore("audioFiles").add({
                name: file.name,
                blob: blob
            }).onsuccess = function (ev) {
                createTile(ev.target.result, file.name, blob);
            };
        };

        reader.readAsArrayBuffer(file);
    });
});

// CREATE TILE
function createTile(id, name, blob) {
    const url = URL.createObjectURL(blob);
    const audio = new Audio(url);

    const col = document.createElement('div');
    col.className = "col-6 col-md-4 col-lg-3";

    const tile = document.createElement('div');
    tile.className = "tile";

    // Name label
    const content = document.createElement('div');
    content.className = "tile-content";
    content.textContent = name;

    // Reset button
    const resetBtn = document.createElement('button');
    resetBtn.className = "reset-btn";
    resetBtn.innerHTML = "↺";

    resetBtn.onclick = (e) => {
        e.stopPropagation();
        audio.currentTime = 0;
    };

    // Progress bar container
    const progressContainer = document.createElement('div');
    progressContainer.className = "progress-container";

    const progress = document.createElement('div');
    progress.className = "progress";
    progress.innerHTML = `<div class="progress-bar" style="width:0%"></div>`;

    progressContainer.appendChild(progress);

    // Append elements
    tile.appendChild(content);
    tile.appendChild(resetBtn);
    tile.appendChild(progressContainer);
    col.appendChild(tile);
    tiles.appendChild(col);

    let playing = false;

    tile.onclick = () => {
        if (!playing) {
            audio.play();
            tile.classList.add('playing');
        } else {
            audio.pause();
            tile.classList.remove('playing');
        }
        playing = !playing;
    };

    // Update progress bar
    audio.addEventListener('timeupdate', () => {
        const percent = (audio.currentTime / audio.duration) * 100;
        progress.querySelector('.progress-bar').style.width = percent + "%";
    });

    // When sound ends
    audio.addEventListener('ended', () => {
        tile.classList.remove('playing');
        playing = false;
        progress.querySelector('.progress-bar').style.width = "0%";
    });
}

// CLEAR LIST
clearBtn.onclick = function () {
    const tx = db.transaction("audioFiles", "readwrite");
    tx.objectStore("audioFiles").clear().onsuccess = function () {
        tiles.innerHTML = "";
    };
};
</script>

</body>
</html>
